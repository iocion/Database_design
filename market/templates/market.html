{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto px-4 py-12 bg-gradient-to-b from-gray-50 to-white min-h-screen">
    <h1 class="text-4xl font-extrabold mb-8 text-center text-gray-900 tracking-tight">药品市场</h1>

    <!-- Search Section -->
    <div class="bg-white rounded-xl shadow-lg p-8 mb-12 transition-all duration-300 hover:shadow-xl">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">查询药品</h2>
        <div class="flex flex-col sm:flex-row gap-4">
            <input type="text" id="searchItemName"
                   class="flex-grow px-4 py-3 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 placeholder-gray-400"
                   placeholder="支持模糊查询">
            <button id="queryItemButton"
                    class="bg-blue-200 hover:bg-blue-300 text-gray-800 font-semibold py-3 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition-colors duration-200">
                <i class="fas fa-search mr-2"></i>
                查询
            </button>
        </div>
        <div id="itemInfo" class="mt-6 p-6 bg-gray-50 rounded-lg shadow-inner transition-all duration-300" style="display: none;">
            <h3 class="text-xl font-semibold mb-3 text-gray-800" id="itemName"></h3>
            <p class="text-gray-600 mb-2" id="itemPrice"></p>
            <p class="text-gray-600 mb-2" id="itemBarcode"></p>
            <p class="text-gray-600 mb-2" id="itemDescription"></p>
            <p class="text-gray-600 mb-2" id="itemQuantity"></p>
            <div id="itemPurchase" class="mt-4"></div>
        </div>
    </div>

    <!-- Available Items Section -->
    <h2 class="text-2xl font-bold mb-6 text-gray-800">可购买的药品</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for item in items %}
        <div class="bg-white rounded-xl shadow-md p-6 flex flex-col justify-between transition-all duration-300 hover:shadow-xl hover:scale-[1.02]">
            <div>
                <p class="text-gray-600 mb-2">序号: <span class="font-semibold text-gray-800">{{ item.id }}</span></p>
                <h3 class="text-xl font-semibold mb-3 text-gray-800">{{ item.name }}</h3>
                <p class="text-gray-600 mb-2">价格: <span class="text-blue-600 font-semibold">{{ item.price }}</span> 元</p>
                <p class="text-gray-600 mb-2">库存: <span class="text-green-600 font-semibold">{{ item.quantity }}</span> 份</p>
                <p class="text-gray-500 text-sm mt-2 line-clamp-2">{{ item.description }}</p>
            </div>
            <div class="mt-4">
                <button type="button" class="w-full bg-blue-200 hover:bg-blue-300 text-gray-800 font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition-colors duration-200" onclick="showPurchaseModal('{{ item.name }}')">
                    <i class="fas fa-shopping-cart mr-2"></i>
                    购买
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Modal for purchasing -->
    <div id="purchaseModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full" style="display: none;">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">选择购买数量</h3>
                <div class="mt-2 px-7 py-3">
                    <input type="number" id="purchaseQuantity" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入数量">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmPurchase" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        确认购买
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const queryItemButton = document.getElementById('queryItemButton');
    const searchItemNameInput = document.getElementById('searchItemName');
    const itemInfoCard = document.getElementById('itemInfo');
    const itemNameDisplay = document.getElementById('itemName');
    const itemPriceDisplay = document.getElementById('itemPrice');
    const itemBarcodeDisplay = document.getElementById('itemBarcode');
    const itemDescriptionDisplay = document.getElementById('itemDescription');
    const itemQuantityDisplay = document.getElementById('itemQuantity');
    const itemPurchaseDiv = document.getElementById('itemPurchase');
    const purchaseModal = document.getElementById('purchaseModal');
    const purchaseQuantityInput = document.getElementById('purchaseQuantity');
    const confirmPurchaseButton = document.getElementById('confirmPurchase');
    let currentItemName = '';

    queryItemButton.addEventListener('click', function() {
        const itemName = searchItemNameInput.value.trim();
        if (itemName === '') {
            alert('请输入药品名称！');
            return;
        }

        fetch(`/api/query/${itemName}`)
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('未找到相关药品');
                    } else {
                        throw new Error('服务器错误');
                    }
                }
                return response.json();
            })
            .then(data => {
                itemNameDisplay.textContent = `药品名称: ${data.name}`;
                itemPriceDisplay.textContent = `价格: ${data.price} 元`;
                itemBarcodeDisplay.textContent = `商品编号: ${data.barcode}`;
                itemDescriptionDisplay.textContent = `描述: ${data.description}`;
                itemQuantityDisplay.textContent = `数量: ${data.quantity} 份`;
                itemPurchaseDiv.innerHTML = `
                    <button type="button" class="w-full bg-blue-200 hover:bg-blue-300 text-gray-800 font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition-colors duration-200" onclick="showPurchaseModal('${data.name}')">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        立即购买
                    </button>
                `;
                itemInfoCard.style.display = 'block';
            })
            .catch(error => {
                alert(error.message);
                itemInfoCard.style.display = 'none';
            });
    });

    window.showPurchaseModal = function(itemName) {
        currentItemName = itemName;
        purchaseModal.style.display = 'block';
    }

    confirmPurchaseButton.addEventListener('click', function() {
        const quantity = purchaseQuantityInput.value;
        if (quantity <= 0) {
            alert('请输入有效的数量');
            return;
        }
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '';
        const itemInput = document.createElement('input');
        itemInput.type = 'hidden';
        itemInput.name = 'purchase_item';
        itemInput.value = currentItemName;
        form.appendChild(itemInput);
        const quantityInput = document.createElement('input');
        quantityInput.type = 'hidden';
        quantityInput.name = 'quantity';
        quantityInput.value = quantity;
        form.appendChild(quantityInput);
        document.body.appendChild(form);
        form.submit();
    });

    purchaseModal.addEventListener('click', function(e) {
        if (e.target === purchaseModal) {
            purchaseModal.style.display = 'none';
        }
    });
});
</script>
{% endblock %}