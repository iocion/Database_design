{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">药品市场</h1>

    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">查询药品</h2>
        <div class="flex flex-col sm:flex-row gap-4">
            <input type="text" id="searchItemName"
                   class="flex-grow px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="支持模糊查询">
            <button id="queryItemButton"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors duration-200">
                <i class="fas fa-search mr-2"></i>
                查询
            </button>
        </div>
        <div id="itemInfo" class="mt-6 p-6 bg-gray-50 rounded-lg shadow-inner" style="display: none;">
            <h3 class="text-xl font-semibold mb-2 text-gray-800" id="itemName"></h3>
            <p class="text-gray-600 mb-2" id="itemPrice"></p>
            <p class="text-gray-600 mb-2" id="itemBarcode"></p>
            <p class="text-gray-600 mb-2" id="itemDescription"></p>
            <p class="text-gray-600 mb-2" id="itemQuantity"></p>
            <div id="itemPurchase" class="mt-4">
                </div>
        </div>
    </div>

    <h2 class="text-2xl font-semibold mb-4 text-gray-800">可购买的药品</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for item in items %}
        <div class="bg-white rounded-lg shadow-md p-4 flex flex-col justify-between transition-transform duration-200 hover:shadow-lg hover:scale-[1.02]">
            <div>
                <!-- <img src="{{ item.image_url }}" alt="{{ item.name }}" class="w-full h-32 object-cover rounded-md mb-4"> -->
                <p class="text-gray-600 mb-2">序号: <span class="text-black-600 font-semibold">{{ item.id }}</span> </p>
                <h3 class="text-xl font-semibold mb-2 text-gray-800">{{ item.name }}</h3>
                <p class="text-gray-600 mb-2">价格: <span class="text-blue-600 font-semibold">{{ item.price }}</span> 元</p>
                <p class="text-gray-600 mb-2">库存: <span class="text-green-600 font-semibold">{{ item.quantity }}</span> 份</p>
                <p class="text-gray-600 text-sm mt-2 line-clamp-2">{{ item.description }}</p>
            </div>
            <div class="mt-4">
                <form method="POST" action="">
                    <input type="hidden" name="purchase_item" value="{{ item.name }}">
                    <button type="submit"
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 transition-colors duration-200">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        购买
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>

    <h2 class="text-2xl font-semibold mt-8 mb-4 text-gray-800">我售卖的药品</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for item in owned_items %}
        <div class="bg-white rounded-lg shadow-md p-4 flex flex-col justify-between transition-transform duration-200 hover:shadow-lg hover:scale-[1.02]">
            <div>
                <h3 class="text-xl font-semibold mb-2 text-gray-800">{{ item.name }}</h3>
                <p class="text-gray-600 mb-2">价格: <span class="text-blue-600 font-semibold">{{ item.price }}</span> 元</p>
                 <p class="text-gray-600 mb-2">库存: <span class="text-green-600 font-semibold">{{ item.quantity }}</span> 份</p>
                <p class="text-gray-600 text-sm mt-2 line-clamp-2">{{ item.description }}</p>

            </div>
            <div class="mt-4">
                <form method="POST" action="">
                    <input type="hidden" name="sold_item" value="{{ item.name }}">
                    <button type="submit"
                            class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 transition-colors duration-200">
                        <i class="fas fa-trash-alt mr-2"></i>
                        下架
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const queryItemButton = document.getElementById('queryItemButton');
    const searchItemNameInput = document.getElementById('searchItemName');
    const itemInfoCard = document.getElementById('itemInfo');
    const itemNameDisplay = document.getElementById('itemName');
    const itemPriceDisplay = document.getElementById('itemPrice');
    const itemBarcodeDisplay = document.getElementById('itemBarcode');
    const itemDescriptionDisplay = document.getElementById('itemDescription');
    const itemQuantityDisplay = document.getElementById('itemQuantity');
    const itemPurchaseDiv = document.getElementById('itemPurchase');

    queryItemButton.addEventListener('click', function() {
        const itemName = searchItemNameInput.value.trim();
        if (itemName === '') {
            alert('请输入药品名称！');
            return;
        }

        fetch(`/api/query/${itemName}`)
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('未找到相关药品');
                    } else {
                        throw new Error('服务器错误');
                    }
                }
                return response.json();
            })
            .then(data => {
                itemNameDisplay.textContent = `药品名称: ${data.name}`;
                itemPriceDisplay.textContent = `价格: ${data.price} 元`;
                itemBarcodeDisplay.textContent = `商品编号: ${data.barcode}</span>`;
                itemDescriptionDisplay.textContent = `描述:${data.description}`;
                itemQuantityDisplay.textContent = `数量: ${data.quantity}份`;
                itemInfoCard.style.display = 'block';
                // 添加购买按钮
                itemPurchaseDiv.innerHTML = `
                    <form method="POST" action="">
                        <input type="hidden" name="purchase_item" value="${data.name}">
                        <button type="submit"
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 transition-colors duration-200">
                            <i class="fas fa-shopping-cart mr-2"></i>
                            立即购买
                        </button>
                    </form>
                `;
                itemInfoCard.style.display = 'block';
            })
            .catch(error => {
                alert(error.message);
                itemInfoCard.style.display = 'none';
            });
    });
});
</script>
{% endblock %}
